<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=description content="Site indépendant de veille sur la géomatique libre et open source. Articles, tutoriels et revues de presse (#GeoRDP) sur l'information géographique, les SIG, la cartographie, la représentation des données..."><meta name=author content=Geotribu><link href=https://static.geotribu.fr/articles/2013/art_2013-02-25/ rel=canonical><link rel="shortcut icon" href=../../../img/favicon.ico><title>Du web, des socquettes et de la carto - Geotribu</title><link href=../../../css/bootstrap.min.css rel=stylesheet><link href=../../../css/font-awesome.min.css rel=stylesheet><link href=../../../css/bootstrap-theme.min.css rel=stylesheet><link href=../../../../../../theme/assets/stylesheets/extra.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/wa-mediabox@1.0.1/dist/wa-mediabox.min.css rel=stylesheet><!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.3/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]--><script src=../../../js/jquery-1.10.2.min.js></script><script src=../../../js/bootstrap.min.js></script><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'None', 'auto');
            ga('send', 'pageview');
        </script></head> <body> <div class="navbar navbar-default navbar-fixed-top" role=navigation> <div class=container> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=../../..>Geotribu</a> </div> <div class="navbar-collapse collapse"> <ul class="nav navbar-nav"> <li> <a href=../../..>&#127968; Accueil</a> </li> <li class=dropdown> <a href=# class=dropdown-toggle data-toggle=dropdown>Revues de presse <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../..>2021</a> </li> <li> <a href=../../..>2020</a> </li> <li> <a href=../../..>2017</a> </li> <li> <a href=../../..>2016</a> </li> <li> <a href=../../..>2015</a> </li> <li> <a href=../../..>2014</a> </li> <li> <a href=../../..>2013</a> </li> <li> <a href=../../..>2012</a> </li> <li> <a href=../../..>2011</a> </li> <li> <a href=../../..>2010</a> </li> </ul> </li> <li class="dropdown active"> <a href=# class=dropdown-toggle data-toggle=dropdown>Articles <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../..>2021</a> </li> <li> <a href=../../..>2020</a> </li> <li> <a href=../../..>2015</a> </li> <li> <a href=../../..>2014</a> </li> <li class=active> <a href=../../..>2013</a> </li> <li> <a href=../../..>2012</a> </li> <li> <a href=../../..>2011</a> </li> <li> <a href=../../..>2010</a> </li> <li> <a href=../../..>2009</a> </li> <li> <a href=../../..>2008</a> </li> </ul> </li> <li class=dropdown> <a href=# class=dropdown-toggle data-toggle=dropdown>Contribuer <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../../contribuer/introduction/ >Contribuer à Geotribu</a> </li> <li> <a href=../../../contribuer/requirements/ >Prérequis pour la contribution</a> </li> <li> <a href=../../../contribuer/contribution_guide/ >Guide de contribution</a> </li> <li> <a href=../../..>Editer le contenu</a> </li> <li> <a href=../../..>Générer le site web</a> </li> <li> <a href=../../..>Guides de rédaction</a> </li> <li> <a href=../../..>Archives</a> </li> </ul> </li> <li class=dropdown> <a href=# class=dropdown-toggle data-toggle=dropdown>A propos <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../../team/ >L'équipe Geotribu</a> </li> <li> <a href=../../../team/acha/ >Aurélien Chaumet</a> </li> <li> <a href=../../../team/avdc/ >Arnaud Vandecasteele</a> </li> <li> <a href=../../../team/avha/ >Adrien Van Hamme</a> </li> <li> <a href=../../../team/edel/ >Etienne Delay</a> </li> <li> <a href=../../../team/fbor/ >Florian Boret</a> </li> <li> <a href=../../../team/fgob/ >Fabien Goblet</a> </li> <li> <a href=../../../team/gdbo/ >Guillaume de Boyer</a> </li> <li> <a href=../../../team/jmou/ >Julien Moura</a> </li> <li> <a href=../../../team/jory/ >Jérémie Ory</a> </li> <li> <a href=../../../team/jpie/ >Julie Pierson</a> </li> <li> <a href=../../../team/mraj/ >Mathieu Rajerison</a> </li> <li> <a href=../../../team/pver/ >Pierre Vernier</a> </li> <li> <a href=../../../team/rbov/ >Rémi Bovard</a> </li> <li> <a href=../../../team/rqui/ >Rodolphe Quiédeville</a> </li> <li> <a href=../../../team/tgra/ >Thomas Gratier</a> </li> <li> <a href=../../..>Archives</a> </li> </ul> </li> </ul> <ul class="nav navbar-nav navbar-right"> <li> <a href=../art_2013-03-07/ rel=next> <i class="fa fa-arrow-left"></i> Previous </a> </li> <li> <a href=../art_2013-02-20/ rel=prev> Next <i class="fa fa-arrow-right"></i> </a> </li> <li> <a href=https://github.com/geotribu/website/ > geotribu/website </a> </li> </ul> </div> </div> </div> <div class=container> <div class=row> <div class=col-md-3><div class="bs-sidebar hidden-print affix well" role=complementary> <ul class="nav bs-sidenav"> <li class="main active"><a href=#du-web-des-socquettes-et-de-la-carto>Du web, des socquettes et de la carto</a></li> <li><a href=#introduction-legere-lintro-pas-dinquietude>Introduction - légère l'intro, pas d'inquiétude :)</a></li> <li><a href=#cest-bien-gentil-tout-ca-mais-cest-quoi-le-sujet-de-ton-tuto>C'est bien gentil tout ça, mais c'est quoi le sujet de ton tuto ?</a></li> <li><a href=#et-les-navigateurs-dans-tout-ca>Et les navigateurs dans tout ça ?</a></li> <li><a href=#la-demo>La démo</a></li> <li><a href=#tips>Tips</a></li> <li><a href=#conclusion>Conclusion</a></li> <li><a href=#auteur>Auteur</a></li> </ul> </div></div> <div class=col-md-9 role=main> <h1 id=du-web-des-socquettes-et-de-la-carto>Du web, des socquettes et de la carto<a class=headerlink href=#du-web-des-socquettes-et-de-la-carto title="Permanent link">#</a></h1> <p>:calendar: Date de publication initiale : 25 février 2013</p> <p><strong>Mots-clés :</strong> Leaflet | PHP | ratchet | WebSocket</p> <p><img alt=websocket class=img-rdp-news-thumb src=https://cdn.geotribu.fr/img/logos-icones/divers/websocket.png></p> <p>Avec un titre pareil je suis pas prêt de me faire référencer... tant pis ce sera pour les initiés :wink:. J'entends souvent parler du temps réel ; la tendance actuelle vers les objects connectés et autres interactions possibles avec des smartphones et/ou des sites web m'a fait (re)découvrir une partie du web que j'avais mise de côté. Et donc l'envie de mettre les mains dans le cambouis et regarder d'un peu plus près comment ça marche ! Et ouais on ne se refait pas.</p> <h2 id=introduction-legere-lintro-pas-dinquietude>Introduction - légère l'intro, pas d'inquiétude :)<a class=headerlink href=#introduction-legere-lintro-pas-dinquietude title="Permanent link">#</a></h2> <h3 id=au-debut-il-y-avait-le-web>Au début il y avait le web<a class=headerlink href=#au-debut-il-y-avait-le-web title="Permanent link">#</a></h3> <p>Je me rappelle des premiers sites web que j'ai pu visiter avec ma connexion <a href=https://fr.wikipedia.org/wiki/R%C3%A9seau_t%C3%A9l%C3%A9phonique_commut%C3%A9>RTC</a> : c'était un peu lent à la connexion (en fait ça mettait une plombe à s'initialiser, le modem faisait un bruit horrible ...), c'était un poil statique, les sites comportaient des gif animés et il n'y avait pas énormément de sites en ligne (dans les 25 000, je vous laisse calculer mon âge, j'étais en seconde :). Bon d'accord y'en a des <a href=http://obsession.nouvelobs.com/mode/20110428.OBS1990/la-revanche-du-gif-anime.html>jolis</a> des gif animés.</p> <h3 id=puis-on-a-entendu-parler-du-web-20>...puis on a entendu parler du web 2.0<a class=headerlink href=#puis-on-a-entendu-parler-du-web-20 title="Permanent link">#</a></h3> <p>Là le <a href=https://fr.wikipedia.org/wiki/Web_2.0>web</a> s'est un peu accéléré, je suis toujours impressionné par les technologies actuelles : ça va vite, ça interagit, ça bouge sans trop ramer, bref c'est chouette ! L'internaute est devenu un acteur du web, il pouvait influer sur le contenu d'une page ou d'une application et voir quasiment en temps réel les modifications qu'il avait apportées - selon moi l'émergence des réseaux sociaux en est l'un des exemples les plus parlant.</p> <h3 id=et-maintenant-lhtml5>...et maintenant l'HTML5<a class=headerlink href=#et-maintenant-lhtml5 title="Permanent link">#</a></h3> <p>L'<a href=http://www.siteduzero.com/informatique/tutoriels/apprenez-a-creer-votre-site-web-avec-html5-et-css3/technologies-liees-a-html5-canvas-svg-web-sockets>HTML5</a> est un ensemble de technologies - il n'y a pas que le HTML ou le CSS - mais aussi les canvas, le svg, la géolocalisation, le web storage et j'en passe.</p> <p>Le sujet qui nous intéresse aujourd'hui est les <a href=https://fr.wikipedia.org/wiki/Websocket>websocket</a> et donc la notion de vrai temps réel (une sorte de super Ajax). [On prend sa respiration ...] Il s'agit donc d'un protocole de communication entre un client et un serveur par la mise en place d'un canal bidirectionnel entre ces deux entités : ça permet de pousser des données du serveur vers le client. Je ne suis pas trop penché sur la question du système de notifications d'Apple avec iOS mais ça semble un peu similaire (dans le principe s'entend, je ne suis pas certain du tout qu'ils utilisent ce protocole).</p> <h2 id=cest-bien-gentil-tout-ca-mais-cest-quoi-le-sujet-de-ton-tuto>C'est bien gentil tout ça, mais c'est quoi le sujet de ton tuto ?<a class=headerlink href=#cest-bien-gentil-tout-ca-mais-cest-quoi-le-sujet-de-ton-tuto title="Permanent link">#</a></h2> <h3 id=tinquiete-paupiette-on-y-vient>T'inquiète paupiette on y vient<a class=headerlink href=#tinquiete-paupiette-on-y-vient title="Permanent link">#</a></h3> <p>En brut de forme : installer un serveur de websocket sans trop se galérer avec l'installation d'un serveur type <a href=http://nodejs.org/ >node.js</a> ou <a href=http://www.ape-project.org/ >APE</a>. On va faire ça simple avec une bibliothèque en PHP qui implémente les websockets. Comme ça hop pas trop de souci sur le serveur de développement et on bousille pas toute la configuration qui nous a pris des années à stabiliser (y'en a un peu de vrai, c'est peut-être pas des années mais un certain temps quand même). Côté performance, aucune idée de savoir si c'est une bonne solution, mais pour une première, ça ira, on fera comme si. Mais j'ai bon espoir :) Puis nous couplerons tout ça avec Leaflet et voir si tout fonctionne.</p> <h3 id=ratchet>Ratchet<a class=headerlink href=#ratchet title="Permanent link">#</a></h3> <p>Et tiens bim, encore un truc nouveau :smile: !</p> <p>En cherchant une bibliothèque PHP qui supportait les websockets je suis tombé inévitablement sur <a href=https://code.google.com/p/phpwebsocket/ >phpwebsocket</a> mais bon ça n'a pas l'air d'être trop mis à jour. Y'a peut-être quelque chose d'autre ? Et oui, c'est <a href=http://socketo.me/ >Ratchet</a> ! Allez c'est parti on va partir sur cette bibliothèque.</p> <h4 id=installation>Installation<a class=headerlink href=#installation title="Permanent link">#</a></h4> <p>Donc facile on se rend sur le site web et hop direct à la page d'<a href=http://socketo.me/docs/install>installation</a>... tiens pas de bouton 'Download'... hum... il faut utiliser <a href=http://getcomposer.org/ >composer</a>... que de trucs nouveaux dans ce tuto :) Donc composer est un installeur de bibliothèques qui gère les dépendances et y'en a besoin pour Ratchet. On ouvre un terminal, on se place à la racine du projet web que l'on vient de créer et hop on attaque :</p> <div class=highlight><pre><span></span><code>toto$ curl -s &lt;https://getcomposer.org/installer&gt; <span class=p>|</span> php -d detect<span class=se>\_</span>unicode<span class=o>=</span>Off
</code></pre></div> <div class="admonition note"> <p class=admonition-title>Note</p> <p>J'ai ajouté <code>detect_unicode=Off</code> ne voulant pas changer cette configuration dans mon <code>php.ini</code>.</p> </div> <p>On a donc le fichier <code>composer.phar</code> téléchargé à la racine. Il faut maintenant écrire un fichier de configuration dans lequel nous ajoutons Ratchet comme dépendance. Il faut éditer un nouveau fichier <code>composer.json</code> à la racine du projet et écrire dedans :</p> <div class=highlight><pre><span></span><code><span class=p>{</span>
    <span class=nt>&quot;autoload&quot;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&quot;psr-0&quot;</span><span class=p>:</span> <span class=p>{</span>
            <span class=nt>&quot;MyApp&quot;</span><span class=p>:</span> <span class=s2>&quot;src&quot;</span>
        <span class=p>}</span>
    <span class=p>},</span>
    <span class=nt>&quot;require&quot;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&quot;cboden/Ratchet&quot;</span><span class=p>:</span> <span class=s2>&quot;0.2.*&quot;</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>Et maintenant on installe Ratchet en lançant la commande suivante :</p> <div class=highlight><pre><span></span><code>toto$ ./composer.phar install
</code></pre></div> <p>On se retrouve avec un nouveau fichier <code>composer.lock</code> et un répertoire <code>vendor</code> qui contient les dépendances de Ratchet pour notre projet.</p> <hr> <h4 id=du-code-du-code-du-code>Du code du code du code<a class=headerlink href=#du-code-du-code-du-code title="Permanent link">#</a></h4> <p>C'est parti ! On crée une nouvelle classe en PHP qui va s'appeler Truc et qui écoutera les 4 événements suivants :</p> <ul> <li><code>onOpen</code> qui est appelé quand un nouveau client se connecte ;</li> <li><code>onMessage</code> appelé quand un message arrive ;</li> <li><code>onClose</code> appelé quand une connexion se ferme ;</li> <li><code>onError</code> appelé quand y'a un blème.</li> </ul> <p>On édite donc un fichier PHP que l'on enregistre ici <code>/src/MyApp/Truc.php</code> - qui utilise la classe de <a href=http://socketo.me/api/class-Ratchet.ConnectionInterface.html>connexion</a> et celle des <a href=http://socketo.me/api/class-Ratchet.MessageComponentInterface.html>messages</a> :</p> <div class=highlight><pre><span></span><code><span class=cp>&lt;?php</span>
<span class=k>namespace</span> <span class=nx>MyApp</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Ratchet\MessageComponentInterface</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Ratchet\ConnectionInterface</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>Truc</span> <span class=k>implements</span> <span class=nx>MessageComponentInterface</span> <span class=p>{</span>
    <span class=k>public</span> <span class=k>function</span> <span class=nf>onOpen</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$conn</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>onMessage</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$from</span><span class=p>,</span> <span class=nv>$msg</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>onClose</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$conn</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>onError</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$conn</span><span class=p>,</span> <span class=nx>\Exception</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
    <span class=p>}</span>
<span class=p>}</span><span class=o>&gt;</span>
</code></pre></div> <p>Evidemment il faudra mettre deux trois trucs dans les fonctions... là en l'état ça ne fait pas grand'chose.</p> <p>Maintenant il faut créer le serveur d'entrées/sorties que l'on va appeler <code>/bin/truc-server.php</code> :</p> <div class=highlight><pre><span></span><code><span class=x>&lt;</span><span class=cp>&lt;?php</span>
<span class=k>use</span> <span class=nx>Ratchet\Server\IoServer</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>MyApp\Truc</span><span class=p>;</span>

    <span class=k>require</span> <span class=nb>dirname</span><span class=p>(</span><span class=no>__DIR__</span><span class=p>)</span> <span class=o>.</span> <span class=s1>&#39;/vendor/autoload.php&#39;</span><span class=p>;</span>

    <span class=nv>$server</span> <span class=o>=</span> <span class=nx>IoServer</span><span class=o>::</span><span class=na>factory</span><span class=p>(</span>
        <span class=k>new</span> <span class=nx>Truc</span><span class=p>(),</span>
        <span class=mi>8080</span>
    <span class=p>);</span>

    <span class=nv>$server</span><span class=o>-&gt;</span><span class=na>run</span><span class=p>();</span>
<span class=cp>?&gt;</span><span class=x></span>
</code></pre></div> <p>On peut d'ores-et-déjà démarrer le serveur comme ça dans un terminal juste pour voir :</p> <div class=highlight><pre><span></span><code>toto$ php bin/truc-server.php
</code></pre></div> <p>Bon en fait on voit rien... hum hum... le script a juste pris possession du terminal - on verra comment écrire des logs dans ce terminal pour voir les connexions entrantes et les actions des clients. Pour quitter c'est Ctrl+C :wink:.</p> <p>On continue en éditant notre classe Truc pour remplir un peu les fonctions des 4 événements déclarés :</p> <div class=highlight><pre><span></span><code><span class=cp>&lt;?php</span>
<span class=k>namespace</span> <span class=nx>MyApp</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Ratchet\MessageComponentInterface</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Ratchet\ConnectionInterface</span><span class=p>;</span>

<span class=k>class</span> <span class=nc>Truc</span> <span class=k>implements</span> <span class=nx>MessageComponentInterface</span> <span class=p>{</span>
    <span class=k>protected</span> <span class=nv>$clients</span><span class=p>;</span>

    <span class=k>public</span> <span class=k>function</span> <span class=fm>__construct</span><span class=p>()</span> <span class=p>{</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clients</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>\SplObjectStorage</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>onOpen</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$conn</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// Store the new connection to send messages to later</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clients</span><span class=o>-&gt;</span><span class=na>attach</span><span class=p>(</span><span class=nv>$conn</span><span class=p>);</span>

        <span class=k>echo</span> <span class=s2>&quot;New connection! (</span><span class=si>{</span><span class=nv>$conn</span><span class=o>-&gt;</span><span class=na>resourceId</span><span class=si>}</span><span class=s2>)</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>onMessage</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$from</span><span class=p>,</span> <span class=nv>$msg</span><span class=p>)</span> <span class=p>{</span>
        <span class=nv>$numRecv</span> <span class=o>=</span> <span class=nb>count</span><span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clients</span><span class=p>)</span> <span class=o>-</span> <span class=mi>1</span><span class=p>;</span>
        <span class=k>echo</span> <span class=nb>sprintf</span><span class=p>(</span><span class=s1>&#39;Connection %d sending message &quot;%s&quot; to %d other connection%s&#39;</span> <span class=o>.</span> <span class=s2>&quot;</span><span class=se>\n</span><span class=s2>&quot;</span>
            <span class=p>,</span> <span class=nv>$from</span><span class=o>-&gt;</span><span class=na>resourceId</span><span class=p>,</span> <span class=nv>$msg</span><span class=p>,</span> <span class=nv>$numRecv</span><span class=p>,</span> <span class=nv>$numRecv</span> <span class=o>==</span> <span class=mi>1</span> <span class=o>?</span> <span class=s1>&#39;&#39;</span> <span class=o>:</span> <span class=s1>&#39;s&#39;</span><span class=p>);</span>

        <span class=k>foreach</span> <span class=p>(</span><span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clients</span> <span class=k>as</span> <span class=nv>$client</span><span class=p>)</span> <span class=p>{</span>
            <span class=k>if</span> <span class=p>(</span><span class=nv>$from</span> <span class=o>!==</span> <span class=nv>$client</span><span class=p>)</span> <span class=p>{</span>
                <span class=c1>// The sender is not the receiver, send to each client connected</span>
                <span class=nv>$client</span><span class=o>-&gt;</span><span class=na>send</span><span class=p>(</span><span class=nv>$msg</span><span class=p>);</span>
            <span class=p>}</span>
        <span class=p>}</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>onClose</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$conn</span><span class=p>)</span> <span class=p>{</span>
        <span class=c1>// The connection is closed, remove it, as we can no longer send it messages</span>
        <span class=nv>$this</span><span class=o>-&gt;</span><span class=na>clients</span><span class=o>-&gt;</span><span class=na>detach</span><span class=p>(</span><span class=nv>$conn</span><span class=p>);</span>

        <span class=k>echo</span> <span class=s2>&quot;Connection </span><span class=si>{</span><span class=nv>$conn</span><span class=o>-&gt;</span><span class=na>resourceId</span><span class=si>}</span><span class=s2> has disconnected</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>;</span>
    <span class=p>}</span>

    <span class=k>public</span> <span class=k>function</span> <span class=nf>onError</span><span class=p>(</span><span class=nx>ConnectionInterface</span> <span class=nv>$conn</span><span class=p>,</span> <span class=nx>\Exception</span> <span class=nv>$e</span><span class=p>)</span> <span class=p>{</span>
        <span class=k>echo</span> <span class=s2>&quot;An error has occurred: </span><span class=si>{</span><span class=nv>$e</span><span class=o>-&gt;</span><span class=na>getMessage</span><span class=p>()</span><span class=si>}</span><span class=se>\n</span><span class=s2>&quot;</span><span class=p>;</span>

        <span class=nv>$conn</span><span class=o>-&gt;</span><span class=na>close</span><span class=p>();</span>
    <span class=p>}</span>
<span class=p>}</span>
</code></pre></div> <p>En simplifié dans l'ordre du code, on a créé un constructeur de notre Truc, à chaque nouvelle connexion on enregistre le client et on écrit un log, à chaque message qui arrive on écrit un log et on envoie le message à tous les autres clients, à chaque déconnexion on supprime le client de notre objet de stockage, et enfin à chaque erreur on écrit dans le terminal que bah y'a eu un problème.</p> <p>Lançons le serveur dans un premier terminal et lançons Telnet dans 3 autres :</p> <div class=highlight><pre><span></span><code>toto$ php bin/truc-server.php
toto$ telnet localhost <span class=m>8080</span>
toto$ telnet localhost <span class=m>8080</span>
toto$ telnet localhost <span class=m>8080</span>
</code></pre></div> <p>Et tapez des insultes dans un des telnet, vous les verrez dans les autres. Et dans le log (ie. le terminal où l'on a lancé le serveur) vous pouvez fliquer les clients ;)</p> <p>Cool, ça marche, on a un serveur de websockets en PHP et plusieurs clients via le protocole TCP/IP peuvent s'envoyer des messages. Maintenant il faut mettre tout ça dans le web et coupler tout ceci dans une jolie carto :)</p> <h3 id=un-peu-dhtmljavascript-avec-de-la-carto-dedans-et-hop-ca-touche-a-sa-fin>Un peu d'HTML/Javascript avec de la carto dedans et hop ça touche à sa fin<a class=headerlink href=#un-peu-dhtmljavascript-avec-de-la-carto-dedans-et-hop-ca-touche-a-sa-fin title="Permanent link">#</a></h3> <p>Il nous reste à écrire une page HTML où nos clients se connecteront. On fait donc une carte où l'on donne la possibilité à l'internaute de cliquer pour ajouter des marqueurs à l'endroit justement où il a cliqué et qui enverra un message aux autres clients qui interpréteront cela comme un marqueur d'un gars extérieur - vous allez voir c'est un poil intrusif :)</p> <p>C'est parti !</p> <p>A la racine du projet on édite un fichier - genre <code>maptruc.html</code> - on aura pris soin de télécharger la bibliothèque <a href=http://leafletjs.com/ >Leaflet</a> dans le répertoire <code>lib/js/leaflet/</code>.</p> <p>Carto Truc Websocket Leaflet :)</p> <div class=highlight><pre><span></span><code><span class=kd>var</span> <span class=nx>stamenUrlToner</span> <span class=o>=</span> <span class=s1>&#39;http://{s}.tile.stamen.com/toner/{z}/{x}/{y}.png&#39;</span><span class=p>,</span> <span class=nx>subDomainsStamen</span> <span class=o>=</span> <span class=p>[</span><span class=s1>&#39;a&#39;</span><span class=p>,</span> <span class=s1>&#39;b&#39;</span><span class=p>,</span> <span class=s1>&#39;c&#39;</span><span class=p>,</span> <span class=s1>&#39;d&#39;</span><span class=p>],</span> <span class=nx>stamenAttrib</span> <span class=o>=</span> <span class=s1>&#39;&lt;span style=&quot;color: #E6A21C;&quot;&gt;GeoTribu Truc&lt;/span&gt; - Map tiles by &lt;a href=&quot;http://stamen.com&quot;&gt;Stamen Design&lt;/a&gt;, under &lt;a href=&quot;http://creativecommons.org/licenses/by/3.0&quot;&gt;CC BY 3.0&lt;/a&gt;. Data by &lt;a href=&quot;http://openstreetmap.org&quot;&gt;OpenStreetMap&lt;/a&gt;, under &lt;a href=&quot;http://creativecommons.org/licenses/by-sa/3.0&quot;&gt;CC BY SA&lt;/a&gt;.&#39;</span><span class=p>;</span>

<span class=kd>var</span> <span class=nx>stamenToner</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>L</span><span class=p>.</span><span class=nx>TileLayer</span><span class=p>(</span><span class=nx>stamenUrlToner</span><span class=p>,</span> <span class=p>{</span> <span class=nx>minZoom</span><span class=o>:</span> <span class=mf>0</span><span class=p>,</span> <span class=nx>maxZoom</span><span class=o>:</span> <span class=mf>20</span><span class=p>,</span> <span class=nx>attribution</span><span class=o>:</span> <span class=nx>stamenAttrib</span><span class=p>,</span> <span class=nx>subdomains</span><span class=o>:</span> <span class=nx>subDomainsStamen</span> <span class=p>});</span>
<span class=kd>var</span> <span class=nx>map</span> <span class=o>=</span> <span class=nx>L</span><span class=p>.</span><span class=nx>map</span><span class=p>(</span><span class=s1>&#39;map&#39;</span><span class=p>,</span> <span class=p>{</span> <span class=nx>center</span><span class=o>:</span> <span class=k>new</span> <span class=nx>L</span><span class=p>.</span><span class=nx>LatLng</span><span class=p>(</span><span class=mf>43.594993</span><span class=p>,</span> <span class=mf>1.435489</span><span class=p>),</span> <span class=nx>zoom</span><span class=o>:</span> <span class=mf>14</span><span class=p>,</span> <span class=nx>zoomControl</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>zoomAnimation</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>scrollWheelZoom</span><span class=o>:</span> <span class=kc>true</span><span class=p>,</span> <span class=nx>layers</span><span class=o>:</span> <span class=p>[</span><span class=nx>stamenToner</span><span class=p>]</span> <span class=p>});</span>
</code></pre></div> <p>On a la carto simple (avec un joli fond de carte de chez <a href=http://stamen.com/ >Stamen Design</a>), maintenant il faut se connecter au serveur de websocket et ajouter des marqueurs.</p> <p>On ajoute des petits marqueurs dans le répertoire <code>img</code> et on en affiche un des deux chaque fois que l'on clique sur la carte :</p> <div class=highlight><pre><span></span><code><span class=kd>var</span> <span class=nx>iconGeoTribu2</span> <span class=o>=</span> <span class=nx>L</span><span class=p>.</span><span class=nx>icon</span><span class=p>({</span> <span class=nx>iconUrl</span><span class=o>:</span> <span class=s1>&#39;img/icn16x28.png&#39;</span><span class=p>,</span> <span class=nx>shadowUrl</span><span class=o>:</span> <span class=s1>&#39;img/shadow-icn16x28.png&#39;</span><span class=p>,</span> <span class=nx>iconSize</span><span class=o>:</span> <span class=p>[</span><span class=mf>16</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>shadowSize</span><span class=o>:</span> <span class=p>[</span><span class=mf>31</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>iconAnchor</span><span class=o>:</span> <span class=p>[</span><span class=mf>8</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>shadowAnchor</span><span class=o>:</span> <span class=p>[</span><span class=mf>8</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>popupAnchor</span><span class=o>:</span> <span class=p>[</span><span class=o>-</span><span class=mf>0</span><span class=p>,</span> <span class=o>-</span><span class=mf>45</span><span class=p>]</span> <span class=p>});</span> <span class=kd>var</span> <span class=nx>iconGeoTribu</span> <span class=o>=</span> <span class=nx>L</span><span class=p>.</span><span class=nx>icon</span><span class=p>({</span> <span class=nx>iconUrl</span><span class=o>:</span> <span class=s1>&#39;img/icn16x28-2.png&#39;</span><span class=p>,</span> <span class=nx>shadowUrl</span><span class=o>:</span> <span class=s1>&#39;img/shadow-icn16x28.png&#39;</span><span class=p>,</span> <span class=nx>iconSize</span><span class=o>:</span> <span class=p>[</span><span class=mf>16</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>shadowSize</span><span class=o>:</span> <span class=p>[</span><span class=mf>31</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>iconAnchor</span><span class=o>:</span> <span class=p>[</span><span class=mf>8</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>shadowAnchor</span><span class=o>:</span> <span class=p>[</span><span class=mf>8</span><span class=p>,</span> <span class=mf>28</span><span class=p>],</span> <span class=nx>popupAnchor</span><span class=o>:</span> <span class=p>[</span><span class=o>-</span><span class=mf>0</span><span class=p>,</span> <span class=o>-</span><span class=mf>45</span><span class=p>]</span> <span class=p>});</span> <span class=kd>var</span> <span class=nx>map</span> <span class=o>=</span><span class=p>...</span> <span class=nx>map</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;click&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span> <span class=nx>L</span><span class=p>.</span><span class=nx>marker</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>latlng</span><span class=p>,{</span><span class=nx>icon</span><span class=o>:</span> <span class=nx>iconGeoTribu</span><span class=p>}).</span><span class=nx>addTo</span><span class=p>(</span><span class=nx>map</span><span class=p>);</span> <span class=p>});</span>
</code></pre></div> <p>Les entrées / sorties fonctionnent, reste à charger les fonctionnalités des websocket dans <code>/bin/truc-server.php</code> pour que ça fonctionne dans les navigateurs un poil récent :</p> <div class=highlight><pre><span></span><code><span class=cp>&lt;?php</span>
<span class=k>use</span> <span class=nx>Ratchet\Server\IoServer</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>Ratchet\WebSocket\WsServer</span><span class=p>;</span>
<span class=k>use</span> <span class=nx>MyApp\Truc</span><span class=p>;</span>

<span class=k>require</span> <span class=nb>dirname</span><span class=p>(</span><span class=no>__DIR__</span><span class=p>)</span> <span class=o>.</span> <span class=s1>&#39;/vendor/autoload.php&#39;</span><span class=p>;</span>

<span class=nv>$server</span> <span class=o>=</span> <span class=nx>IoServer</span><span class=o>::</span><span class=na>factory</span><span class=p>(</span> <span class=k>new</span> <span class=nx>WsServer</span><span class=p>(</span> <span class=k>new</span> <span class=nx>Truc</span><span class=p>()</span> <span class=p>)</span> <span class=p>,</span> <span class=mi>8080</span> <span class=p>);</span>
<span class=nv>$server</span><span class=o>-</span><span class=nx>run</span><span class=p>();</span>

<span class=cp>?&gt;</span><span class=x></span>
</code></pre></div> <p>Encore 8 lignes et c'est fini ! On se connecte sur le serveur de websocket et on code quelques fonctionnalités :</p> <ol> <li>quand on clique sur la carte - ça ajoute un marqueur sur la sienne et ça envoie un message (ie. on envoie que les coordonnées du marqueur) aux autres clients</li> <li>et quand on reçoit un message on récupère le message (des coordonnées donc, vous suivez ?) et on ajoute un marqueur d'une autre couleur sur la carte :</li> </ol> <div class=highlight><pre><span></span><code><span class=kd>var</span> <span class=nx>conn</span> <span class=o>=</span> <span class=k>new</span> <span class=nx>WebSocket</span><span class=p>(</span><span class=s1>&#39;ws://192.168.1.184:8080&#39;</span><span class=p>);</span> <span class=nx>conn</span><span class=p>.</span><span class=nx>onopen</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span> <span class=nx>console</span><span class=p>.</span><span class=nx>log</span><span class=p>(</span><span class=s2>&quot;Connection established!&quot;</span><span class=p>);</span> <span class=p>};</span> <span class=nx>conn</span><span class=p>.</span><span class=nx>onmessage</span> <span class=o>=</span> <span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span> <span class=kd>var</span> <span class=nx>temp</span> <span class=o>=</span> <span class=nx>e</span><span class=p>.</span><span class=nx>data</span><span class=p>;</span> <span class=kd>var</span> <span class=nx>tab</span> <span class=o>=</span> <span class=nx>temp</span><span class=p>.</span><span class=nx>split</span><span class=p>(</span><span class=s2>&quot;,&quot;</span><span class=p>);</span> <span class=nx>L</span><span class=p>.</span><span class=nx>marker</span><span class=p>(</span><span class=k>new</span> <span class=nx>L</span><span class=p>.</span><span class=nx>LatLng</span><span class=p>(</span><span class=nx>tab</span><span class=p>[</span><span class=mf>0</span><span class=p>],</span><span class=nx>tab</span><span class=p>[</span><span class=mf>1</span><span class=p>]),{</span><span class=nx>icon</span><span class=o>:</span> <span class=nx>iconGeoTribu2</span><span class=p>}).</span><span class=nx>addTo</span><span class=p>(</span><span class=nx>map</span><span class=p>);</span> <span class=p>};</span> <span class=p>[...]</span> <span class=nx>map</span><span class=p>.</span><span class=nx>on</span><span class=p>(</span><span class=s1>&#39;click&#39;</span><span class=p>,</span> <span class=kd>function</span><span class=p>(</span><span class=nx>e</span><span class=p>)</span> <span class=p>{</span> <span class=nx>L</span><span class=p>.</span><span class=nx>marker</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>latlng</span><span class=p>,{</span><span class=nx>icon</span><span class=o>:</span> <span class=nx>iconGeoTribu</span><span class=p>}).</span><span class=nx>addTo</span><span class=p>(</span><span class=nx>map</span><span class=p>);</span> <span class=nx>conn</span><span class=p>.</span><span class=nx>send</span><span class=p>(</span><span class=nx>e</span><span class=p>.</span><span class=nx>latlng</span><span class=p>.</span><span class=nx>lat</span><span class=o>+</span><span class=s1>&#39;,&#39;</span><span class=o>+</span><span class=nx>e</span><span class=p>.</span><span class=nx>latlng</span><span class=p>.</span><span class=nx>lng</span><span class=p>);</span> <span class=p>});</span>
</code></pre></div> <p>Modifiez l'adresse IP à la première ligne par la votre. Et c'est tout bon !</p> <h2 id=et-les-navigateurs-dans-tout-ca>Et les navigateurs dans tout ça ?<a class=headerlink href=#et-les-navigateurs-dans-tout-ca title="Permanent link">#</a></h2> <p>Bonne nouvelle, tous les navigateurs supportent les websocket même sur smartphone :) Bon ok il en manque un... je vous le donne dans le mille... IE c'est seulement à partir de la version 10 :/ Aux 11% qui lisent GeoTribu avec IE, essayez de changer, juste comme ça pour voir, les autres navigateurs sont pas mal franchement :wink:</p> <h2 id=la-demo>La démo<a class=headerlink href=#la-demo title="Permanent link">#</a></h2> <div class="admonition tip"> <p class=admonition-title>Tip</p> <p>Bon c'est sûr, il faut que plusieurs visiteurs soient sur le tuto en même temps pour voir quelque chose... Au pire ouvrez deux onglets et jouez avec vous-même.</p> </div> <p>Pour la pleine page c'est par <a href=http://88.191.142.86/labs/websocket/maptruc.html>ici</a>.</p> <p>Si vous êtes seul sur ce tuto mais que vous avez un smartphone sous la main - testez la démo avec ! Flashouillez le code et hop cliquez sur la carte.</p> <p><img alt src=https://cdn.geotribu.fr/img/articles-blog-rdp/divers/qrcode_test-websocket.png></p> <p>Bon il se peut que le serveur de websocket ne fonctionne pas tout le temps - et ouais c'est une démo ! Et il se peut que vous ayez à modifier le port 8080 par autre chose. Souvent il est pris par Tomcat ce port. Et il faut avoir installé php5-curl, ça marchera mieux.</p> <h2 id=tips>Tips<a class=headerlink href=#tips title="Permanent link">#</a></h2> <p>Si vous voulez lancer le script de manière un peu durable il convient de rediriger les logs vers un fichier ad-hoc :</p> <div class=highlight><pre><span></span><code>php ./bin/truc-server.php <span class=m>1</span>&gt; ./script.log <span class=m>2</span>&gt;<span class=p>&amp;</span><span class=m>1</span> <span class=p>&amp;</span>
</code></pre></div> <h2 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">#</a></h2> <p>Bon évidemment c'est un petit tuto pour voir comment tout ça fonctionne, mais de mon côté je suis enchanté, ça ouvre pas mal de perspectives et je compte m'y coller plus franchement : pourquoi pas installer <code>nodejs</code> (qui contient la bibliothèque Javascript socket.io qui gère le protocole des websockets) et une base de données NoSQL qui délivre du json en natif (surtout vrai pour <a href=http://couchdb.apache.org/ >CouchDB</a>) et du coup n'avoir que du Javascript partout. Imaginez ce que l'on pourrait faire avec le plugin <a href=http://www.geotribu.net/node/573#news14>Draw</a> de Leaflet ! De la co-édition d'objets géographiques en temps réel par exemple ! Wahou !</p> <hr> <h2 id=auteur>Auteur<a class=headerlink href=#auteur title="Permanent link">#</a></h2> <p><img alt="Portait de Fabien Goblet" class=img-rdp-news-thumb src=https://cdn.geotribu.fr/img/internal/charte/geotribu_logo_64x64.png> <strong>Fabien Goblet</strong></p> <p>Fabien est l'un des fondateurs de Geotribu.</p></div> </div> </div> <hr> <footer class=container> <center><span class=copyleft>&copy;</span> Geotribu</center> <center>Documentation built with <a href=http://www.mkdocs.org>MkDocs</a> and <a href=http://kristopolous.github.io/BOOTSTRA.386>BOOTSTRA.386</a>.</center> </footer> <script src=../../../../../../theme/assets/javascripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/wa-mediabox@1.0.1/dist/wa-mediabox.min.js></script> <script src=https://unpkg.com/mermaid@8.6.4/dist/mermaid.min.js></script> <script src=../../../../../../search/main.js></script> </body> </html>