<!DOCTYPE html><html lang=en> <head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width, initial-scale=1.0"><meta name=description content="Site indépendant de veille sur la géomatique libre et open source. Articles, tutoriels et revues de presse (#GeoRDP) sur l'information géographique, les SIG, la cartographie, la représentation des données..."><meta name=author content=Geotribu><link href=https://static.geotribu.fr/articles/2012/art_2012-04-17/ rel=canonical><link rel="shortcut icon" href=../../../img/favicon.ico><title>Calcul de buffer sous MySQL - 2ème partie - la pratique - Geotribu</title><link href=../../../css/bootstrap.min.css rel=stylesheet><link href=../../../css/font-awesome.min.css rel=stylesheet><link href=../../../css/bootstrap-theme.min.css rel=stylesheet><link href=../../../../../../theme/assets/stylesheets/extra.css rel=stylesheet><link href=https://cdn.jsdelivr.net/npm/wa-mediabox@1.0.1/dist/wa-mediabox.min.css rel=stylesheet><!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.3/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]--><script src=../../../js/jquery-1.10.2.min.js></script><script src=../../../js/bootstrap.min.js></script><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'None', 'auto');
            ga('send', 'pageview');
        </script></head> <body> <div class="navbar navbar-default navbar-fixed-top" role=navigation> <div class=container> <div class=navbar-header> <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse> <span class=sr-only>Toggle navigation</span> <span class=icon-bar></span> <span class=icon-bar></span> <span class=icon-bar></span> </button> <a class=navbar-brand href=../../..>Geotribu</a> </div> <div class="navbar-collapse collapse"> <ul class="nav navbar-nav"> <li> <a href=../../..>&#127968; Accueil</a> </li> <li class=dropdown> <a href=# class=dropdown-toggle data-toggle=dropdown>Revues de presse <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../..>2021</a> </li> <li> <a href=../../..>2020</a> </li> <li> <a href=../../..>2017</a> </li> <li> <a href=../../..>2016</a> </li> <li> <a href=../../..>2015</a> </li> <li> <a href=../../..>2014</a> </li> <li> <a href=../../..>2013</a> </li> <li> <a href=../../..>2012</a> </li> <li> <a href=../../..>2011</a> </li> <li> <a href=../../..>2010</a> </li> </ul> </li> <li class="dropdown active"> <a href=# class=dropdown-toggle data-toggle=dropdown>Articles <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../..>2021</a> </li> <li> <a href=../../..>2020</a> </li> <li> <a href=../../..>2015</a> </li> <li> <a href=../../..>2014</a> </li> <li> <a href=../../..>2013</a> </li> <li class=active> <a href=../../..>2012</a> </li> <li> <a href=../../..>2011</a> </li> <li> <a href=../../..>2010</a> </li> <li> <a href=../../..>2009</a> </li> <li> <a href=../../..>2008</a> </li> </ul> </li> <li class=dropdown> <a href=# class=dropdown-toggle data-toggle=dropdown>Contribuer <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../../contribuer/introduction/ >Contribuer à Geotribu</a> </li> <li> <a href=../../../contribuer/requirements/ >Prérequis pour la contribution</a> </li> <li> <a href=../../../contribuer/contribution_guide/ >Guide de contribution</a> </li> <li> <a href=../../..>Editer le contenu</a> </li> <li> <a href=../../..>Générer le site web</a> </li> <li> <a href=../../..>Guides de rédaction</a> </li> <li> <a href=../../..>Archives</a> </li> </ul> </li> <li class=dropdown> <a href=# class=dropdown-toggle data-toggle=dropdown>A propos <b class=caret></b></a> <ul class=dropdown-menu> <li> <a href=../../../team/ >L'équipe Geotribu</a> </li> <li> <a href=../../../team/acha/ >Aurélien Chaumet</a> </li> <li> <a href=../../../team/avdc/ >Arnaud Vandecasteele</a> </li> <li> <a href=../../../team/avha/ >Adrien Van Hamme</a> </li> <li> <a href=../../../team/edel/ >Etienne Delay</a> </li> <li> <a href=../../../team/fbor/ >Florian Boret</a> </li> <li> <a href=../../../team/fgob/ >Fabien Goblet</a> </li> <li> <a href=../../../team/gdbo/ >Guillaume de Boyer</a> </li> <li> <a href=../../../team/jmou/ >Julien Moura</a> </li> <li> <a href=../../../team/jory/ >Jérémie Ory</a> </li> <li> <a href=../../../team/jpie/ >Julie Pierson</a> </li> <li> <a href=../../../team/mraj/ >Mathieu Rajerison</a> </li> <li> <a href=../../../team/pver/ >Pierre Vernier</a> </li> <li> <a href=../../../team/rbov/ >Rémi Bovard</a> </li> <li> <a href=../../../team/rqui/ >Rodolphe Quiédeville</a> </li> <li> <a href=../../../team/tgra/ >Thomas Gratier</a> </li> <li> <a href=../../..>Archives</a> </li> </ul> </li> </ul> <ul class="nav navbar-nav navbar-right"> <li> <a href=../art_2012-05-09/ rel=next> <i class="fa fa-arrow-left"></i> Previous </a> </li> <li> <a href=../art_2012-03-15/ rel=prev> Next <i class="fa fa-arrow-right"></i> </a> </li> <li> <a href=https://github.com/geotribu/website/ > geotribu/website </a> </li> </ul> </div> </div> </div> <div class=container> <div class=row> <div class=col-md-3><div class="bs-sidebar hidden-print affix well" role=complementary> <ul class="nav bs-sidenav"> <li class="main active"><a href=#calcul-de-buffer-sous-mysql-2eme-partie-la-pratique>Calcul de buffer sous MySQL - 2ème partie - la pratique</a></li> <li><a href=#la-base-de-donnees>La base de données</a></li> <li><a href=#des-poi-des-poi-toujours-des-poi>Des POI, des POI, toujours des POI</a></li> <li><a href=#un-peu-de-parsing-avec-php>Un peu de parsing avec PHP</a></li> <li><a href=#preparons-notre-carte-google-maps>Préparons notre carte Google Maps</a></li> <li><a href=#xmlhttprequest>XMLHttpRequest</a></li> <li><a href=#chargeons-les-marqueurs-et-affichons-les>Chargeons les marqueurs et affichons-les</a></li> <li><a href=#une-petite-infobulle>Une petite infobulle</a></li> <li><a href=#le-script-qui-genere-le-xml-avec-les-marqueurs>Le script qui génère le XML avec les marqueurs</a></li> <li><a href=#code-complet-cote-client>Code complet côté client</a></li> <li><a href=#et-cote-serveur>Et côté serveur</a></li> <li><a href=#conclusion>Conclusion</a></li> <li><a href=#auteur>Auteur</a></li> </ul> </div></div> <div class=col-md-9 role=main> <h1 id=calcul-de-buffer-sous-mysql-2eme-partie-la-pratique>Calcul de buffer sous MySQL - 2ème partie - la pratique<a class=headerlink href=#calcul-de-buffer-sous-mysql-2eme-partie-la-pratique title="Permanent link">#</a></h1> <p>:calendar: Date de publication initiale : 17 avril 2012</p> <p><strong>Mots-clés :</strong> mysql | buffer | rayon | Terre | latitude | longitude</p> <p><img alt=mysql.png src=http://geotribu.net/sites/default/files/Tuto/img/Blog/mysql.png> Pour mettre en application le <a href=http://www.geotribu.net/node/504>premier article</a> sur le calcul de buffer dans MySQL, nous allons développer une petite démo. Tout d'abord il nous faudra initialiser une base de données qui contiendra pas mal d'enregistrements, puis nous alimenterons cette base avec des points d'intérêts provenant d'OpenStreetMap et enfin nous développerons une carto avec l'API Google Maps pour tester la formule Haversine.</p> <h4 id=la-base-de-donnees>La base de données<a class=headerlink href=#la-base-de-donnees title="Permanent link">#</a></h4> <p>Créons une base de données sous MySQL :</p> <p>CREATE DATABASE IF NOT EXISTS osmtestpoi </p> <p>Puis ajoutons une table contentant un champ de type GEOMETRY :</p> <p>CREATE TABLE poi (<br> id_poi INT NOT NULL AUTO_INCREMENT,<br> name_poi VARCHAR(100),<br> geom_poi GEOMETRY,<br> PRIMARY KEY (id_poi)<br> ) ENGINE=INNODB DEFAULT CHARSET=utf8; </p> <h4 id=des-poi-des-poi-toujours-des-poi>Des POI, des POI, toujours des POI<a class=headerlink href=#des-poi-des-poi-toujours-des-poi title="Permanent link">#</a></h4> <p>Pour la démo, il nous faut un grand nombre d'enregistrements. Au lieu de générer des faux points, autant s'amuser un peu avec les nouveaux <a href=http://wiki.openstreetmap.org/wiki/FR:Servers/Hardware#Dell_R610>serveurs</a> et services proposés par <a href=http://openstreetmap.fr/ >OpenStreetMap France</a>. Parmi les services nous utiliserons ici l'<a href=http://wiki.openstreetmap.org/wiki/Overpass_API>OverpassAPI</a> qui permet de faire des extractions : il suffit de faire la bonne requête pour extraire ce que nous désirons (par exemple les restaurants dans une France métropolitaine un peu élargie). Nous allons donc utiliser la <a href=http://api.openstreetmap.fr/query_form.html>boîte de requête</a> en ligne pour extraire les POI :</p> <p>Qui nous renverra un fichier d'environ 10 Mo que nous pousserons dans la base de données. L'OverpassAPI fournit un fichier XML OSMifié. Il suffit donc de parser le fichier et d'écrire un petit script pour alimenter la base.</p> <h4 id=un-peu-de-parsing-avec-php>Un peu de parsing avec PHP<a class=headerlink href=#un-peu-de-parsing-avec-php title="Permanent link">#</a></h4> <p>Pour alimenter la base de données, nous utiliserons ici le PHP. N'importe quel autre langage de scripts fait l'affaire. Voici un extrait de l'export d'OverpassAPI :</p> <p>C'est du XML et PHP sait le lire et le <a href=http://php.net/manual/fr/function.simplexml-load-file.php>transformer</a> en objet. C'est assez pratique ! </p> <p>Bon un peu de code :</p> <ol> <li>On se connecte à la base de données.</li> <li>On regarde si le fichier existe.</li> <li>Pour chaque node, on récupère le nom si il existe.</li> <li>On fait une petite requête d'insertion dans la table.</li> <li>Et voilà !</li> </ol> <p>php &lt;/p define('HOST', 'localhost');<br> define('PORT', '5432');<br> define('DB_USER', 'mylogin');<br> define('DB_PASS', 'mypass');<br> define('DB_NAME', 'osmtestpoi');</p> <p>if (file_exists('./resources/osm/osmrestotoulouse.osm')) {<br> $link = mysql_connect(HOST,DB_USER,DB_PASS);<br> mysql_select_db(DB_NAME);<br> $xml = simplexml_load_file('./resources/osm/osmrestotoulouse.osm');<br> foreach ($xml-&gt;node as $node) {<br> $existname = 0;<br> foreach ($node-&gt;tag as $tag) {<br> if ((string) $tag['k'] == 'name') {<br> $name = mysql_real_escape_string($tag['v']);<br> $existname = 1;<br> } else {<br> $name = "";<br> }<br> }<br> switch ($existname) {<br> case 0:<br> $sql = "INSERT INTO poi (id_poi, geom_poi) VALUES (".$node['id'].",GeomFromText('POINT(".$node['lon']." ".$node['lat'].")'))";<br> break;<br> case 1:<br> $sql = "INSERT INTO poi (id_poi, name_poi, geom_poi) VALUES (".$node['id'].",'".$name."',GeomFromText('POINT(".$node['lon']." ".$node['lat'].")'))";<br> break;<br> }<br> $result = mysql_query($sql);<br> if (!$result) {<br> echo "Requête invalide : ".mysql_error()."<br> ";<br> } else {<br> echo $node['id']." =&gt; insert<br> ";<br> }<br> }<br> mysql_free_result($result);<br> mysql_close($link);<br> } else {<br> exit('gloubs - il est où le fichier :/');<br> }</p> <p>?&gt; </p> <h4 id=preparons-notre-carte-google-maps>Préparons notre carte Google Maps<a class=headerlink href=#preparons-notre-carte-google-maps title="Permanent link">#</a></h4> <p>Ca fait quelques temps que nous n'avons pas développé avec l'API Google Maps ; malgré les désaffections des gros utilisateurs au profit d'OpenStreetMap, ça n'en reste pas moins une très belle librairie.</p> <p>Calcul de buffer sous MySQL </p> <p>html, body, #map_canvas { margin: 0; padding: 0; height: 100%; } var map; function initialize() { var myOptions = { zoom: 6, center: new google.maps.LatLng(46.89, 2.61), mapTypeId: google.maps.MapTypeId.ROADMAP }; map = new google.maps.Map(document.getElementById('map_canvas'), myOptions); } google.maps.event.addDomListener(window, 'load', initialize); </p> <h4 id=xmlhttprequest>XMLHttpRequest<a class=headerlink href=#xmlhttprequest title="Permanent link">#</a></h4> <p>Nous avons besoin d'une connexion Ajax vers le script PHP pour "aller chercher" nos marqueurs dans la base de données. Contrairement à l'API v2 qui proposait un connecteur par défaut, dans la v3 il faut le déclarer. Souvent nous n'avons pas besoin de coder cette fonction avec l'usage intensif de jQuery ou autre. Mais c'est pas plus mal de savoir ce que l'on fait :</p> <p>function downloadUrl(url,callback) {<br> var request = window.ActiveXObject ? new ActiveXObject('Microsoft.XMLHTTP') : new XMLHttpRequest;<br> request.onreadystatechange = function() {<br> if (request.readyState == 4) {<br> request.onreadystatechange = doNothing;<br> callback(request, request.status);<br> }<br> };<br> request.open('GET', url, true);<br> request.send(null);<br> }</p> <p>function doNothing() {} </p> <h4 id=chargeons-les-marqueurs-et-affichons-les>Chargeons les marqueurs et affichons-les<a class=headerlink href=#chargeons-les-marqueurs-et-affichons-les title="Permanent link">#</a></h4> <p>Dans le corps de la fonction, on fait un appel vers le script PHP et on parcourt le XML généré pour ajouter les marqueurs sur la carte :</p> <p>downloadUrl("getMarker.php", function(data) {<br> var xml = data.responseXML;<br> var markers = xml.documentElement.getElementsByTagName("marker");<br> for (var i = 0; i &lt; markers.length; i++) {<br> var name = markers[i].getAttribute("name");<br> var type = markers[i].getAttribute("type");<br> var point = new google.maps.LatLng(parseFloat(markers[i].getAttribute("lat")), parseFloat(markers[i].getAttribute("lng")));<br> var html = "<strong>" + name + "</strong><br> " + address;<br> var marker = new google.maps.Marker({<br> map: map,<br> position: point<br> });<br> bindInfoWindow(marker, map, infoWindow, html);<br> }<br> }); </p> <h4 id=une-petite-infobulle>Une petite infobulle<a class=headerlink href=#une-petite-infobulle title="Permanent link">#</a></h4> <p>Ajoutons l'événement qui ouvre l'infobulle :</p> <p>function bindInfoWindow(marker, map, infoWindow, html) {<br> google.maps.event.addListener(marker, 'click', function() {<br> infoWindow.setContent(html);<br> infoWindow.open(map, marker);<br> });<br> } </p> <h4 id=le-script-qui-genere-le-xml-avec-les-marqueurs>Le script qui génère le XML avec les marqueurs<a class=headerlink href=#le-script-qui-genere-le-xml-avec-les-marqueurs title="Permanent link">#</a></h4> <p>Ici pas trop de souci, nous éditons le XML contenant les marqueurs en manipulant le DOM pour gérer la construction du fichier XML : il s'agit dune simple requête SQL - c'est ce script qu'il faudra changer pour prendre en compte le rayon de recherche et le centre.</p> <p>php header("Content-type: text/xml");&lt;/p define('HOST', 'localhost');<br> define('PORT', '5432');<br> define('DB_USER', 'mylogin');<br> define('DB_PASS', 'mypass');<br> define('DB_NAME', 'osmtestpoi');</p> <p>$link = mysql_connect(HOST,DB_USER,DB_PASS);<br> mysql_select_db(DB_NAME);</p> <p>$dom = new DOMDocument("1.0");<br> $node = $dom-&gt;createElement("markers");<br> $parnode = $dom-&gt;appendChild($node);</p> <p>$query = "SELECT poi.id_poi, poi.name_poi, x(geom_poi) AS X, y(geom_poi) AS Y FROM poi WHERE 1";<br> $result = mysql_query($query);</p> <p>while ($row = @mysql_fetch_assoc($result)) {<br> $node = $dom-&gt;createElement("marker");<br> $newnode = $parnode-&gt;appendChild($node);<br> $newnode-&gt;setAttribute("name",$row['name_poi']);<br> $newnode-&gt;setAttribute("lat", $row['Y']);<br> $newnode-&gt;setAttribute("lng", $row['X']);<br> $newnode-&gt;setAttribute("type", "restaurant");<br> }</p> <p>echo $dom-&gt;saveXML();</p> <p>mysql_free_result($result);<br> mysql_close($link);</p> <p>?&gt; </p> <p>Exemple sur Toulouse sans buffer - éviter de le faire avec la France - votre navigateur risque de ne pas trop apprécier le chargement ;)</p> <p>Hum : j'ai testé la carte avec toutes les données contenues en base (un peu plus de 47000 restaurants) ; bah le navigateur a un peu de mal, faut vraiment mettre en place ce système de buffer - d'ailleurs on peut remarquer qu'il y a beaucoup plus de restaurants recensés chez nos voisins :</p> <p><img alt src=https://cdn.geotribu.fr/img/Blog/tropdepoi.png></p> <h4 id=code-complet-cote-client>Code complet côté client<a class=headerlink href=#code-complet-cote-client title="Permanent link">#</a></h4> <p>Pour afficher les marqueurs contenus dans un cercle, il faut modifier un peu le code côté client ci-dessus :</p> <ul> <li>mettre les marqueurs dans un tableau de marqueurs ;</li> <li>écrire une fonction qui supprime les marqueurs lorsque l'on bouge le cercle de recherche ;</li> <li>ajouter des événements sur le cercle - quand on le bouge et quand on modifie son rayon. Un peu de CSS :</li> </ul> <p>html, body { margin: 0; padding: 0; height: 100%; } #map_canvas { float: left; } #form_canvas { float: left; margin: 5px; } #maxbuffer { color: red; font-size: 10px; } On ajoute jQuery parce que c'est bien pratique :</p> <p>Déclaration des variables et écriture des fonctions :</p> <p>var map;<br> var markersArray = [];<br> var buffer;<br> var circle;<br> var uri;<br> var infoWindow;</p> <p>function clearMarkers() {<br> if (markersArray) {<br> for (i in markersArray) {<br> markersArray[i].setMap(null);<br> }<br> }<br> }</p> <p>function getMarker() {<br> downloadUrl(uri, function(data) {<br> var xml = data.responseXML;<br> var markers = xml.documentElement.getElementsByTagName("marker");<br> for (var i = 0; i &lt; markers.length; i++) {<br> var name = markers[i].getAttribute("name");<br> var type = markers[i].getAttribute("type");<br> var point = new google.maps.LatLng(parseFloat(markers[i].getAttribute("lat")), parseFloat(markers[i].getAttribute("lng")));<br> var html = "<strong>" + name + "</strong>";<br> var marker = new google.maps.Marker({<br> map: map,<br> position: point<br> });<br> markersArray.push(marker);<br> bindInfoWindow(marker, map, infoWindow, html);<br> }<br> });<br> } </p> <p>Puis initialisons un cercle de recherche et des événements lorsque l'utilisateur modifie celui-ci :</p> <p>infoWindow = new google.maps.InfoWindow;</p> <p>circle = new google.maps.Circle({<br> map: map,<br> fillColor: '#ff8922',<br> fillOpacity: 0.2,<br> strokeWeight: 0,<br> clickable: false,<br> editable: true,<br> center: new google.maps.LatLng(46.83, 2.50),<br> radius: 50000<br> });<br> buffer = circle.getRadius() / 1000;<br> uri = "getMarker.php?lat="+circle.getCenter().lat()+"&amp;lng="+circle.getCenter().lng()+"&amp;buffer="+buffer;<br> getMarker();</p> <p>google.maps.event.addListener(circle, 'center_changed', function(e) {<br> clearMarkers();<br> if (circle.getRadius() &gt; 50000) {<br> circle.setRadius(50000);<br> $("#maxbuffer").show().delay(1000).queue(function(n) {<br> $(this).hide(); n();<br> });<br> }<br> buffer = circle.getRadius() / 1000;<br> uri = "getMarker.php?lat="+circle.getCenter().lat()+"&amp;lng="+circle.getCenter().lng()+"&amp;buffer="+buffer;<br> getMarker();<br> $("#lat").val(circle.getCenter().lat());<br> $("#lng").val(circle.getCenter().lng());<br> $("#rayon").val(Math.round(circle.getRadius()/1000));<br> });</p> <p>google.maps.event.addListener(circle, 'radius_changed', function(e) {<br> clearMarkers();<br> if (circle.getRadius() &gt; 50000) {<br> circle.setRadius(50000);<br> $("#maxbuffer").show().delay(1000).queue(function(n) {<br> $(this).hide(); n();<br> });<br> }<br> buffer = circle.getRadius() / 1000;<br> uri = "getMarker.php?lat="+circle.getCenter().lat()+"&amp;lng="+circle.getCenter().lng()+"&amp;buffer="+buffer;<br> getMarker();<br> $("#lat").val(circle.getCenter().lat());<br> $("#lng").val(circle.getCenter().lng());<br> $("#rayon").val(Math.round(circle.getRadius()/1000));<br> });</p> <p>$("#lat").val(circle.getCenter().lat());<br> $("#lng").val(circle.getCenter().lng());<br> $("#rayon").val(Math.round(circle.getRadius()/1000)); </p> <p>Ajoutons un petit bloc d'informations :</p> <p>Centre et buffer<br> latitude : </p> <p>longitude : </p> <p>rayon : </p> <ul> <li>Buffer 50 km maximum</li> </ul> <h4 id=et-cote-serveur>Et côté serveur<a class=headerlink href=#et-cote-serveur title="Permanent link">#</a></h4> <p>On cherche dans la base de données les enregistrements qui sont dans la bounding box calculée dans le premier article et qui sont à une distance inférieure au buffer :</p> <p>php header("Content-type: text/xml");&lt;/p define('HOST', 'localhost');<br> define('PORT', '5432');<br> define('DB_USER', 'mylogin');<br> define('DB_PASS', 'mypass');<br> define('DB_NAME', 'osmtestpoi');</p> <p>$link = mysql_connect(HOST,DB_USER,DB_PASS);<br> mysql_select_db(DB_NAME);</p> <p>$dom = new DOMDocument("1.0");<br> $node = $dom-&gt;createElement("markers");<br> $parnode = $dom-&gt;appendChild($node);</p> <p>$query = "SELECT poifrance.id_poi, poifrance.name_poi, y(poifrance.geom_poi) AS Y,<br> x(poifrance.geom_poi) AS X,<br> 6371 <em>2</em> asin(sqrt(power(sin((".$_GET['lat']." - abs(y(poifrance.geom_poi))) * pi() / 180 / 2), 2) </p> <ul> <li> <p>cos(".$_GET['lat']." <em>pi() / 180)</em> cos(abs(y(poifrance.geom_poi)) * pi() / 180) </p> </li> <li> <p>power(sin((".$_GET['lng']." - x(poifrance.geom_poi)) <em>pi() / 180 / 2), 2) )) AS distance FROM poifrance WHERE 1 = 1 ";<br> if (isset($_GET['lat']) &amp;&amp; isset($_GET['lng']) &amp;&amp; isset($_GET['buffer'])) {<br> $deglat = 111.195;<br> $lat = $_GET['lat'];<br> $lng = $_GET['lng'];<br> $buffer = $_GET['buffer'];<br> $query .= " AND y(poifrance.geom_poi) BETWEEN ".$lat." - (".$buffer." / ".$deglat.")<br> AND ".$lat." + (".$buffer." / ".$deglat.") ";<br> $query .= " AND x(poifrance.geom_poi) BETWEEN ".$lng." - ".$buffer." / ABS(COS(RADIANS(".$lat."))</em> ".$deglat.")<br> AND ".$lng." + ".$buffer." / ABS(COS(RADIANS(".$lat.")) * ".$deglat.")";<br> $query .= " HAVING distance &lt; ".$_GET['buffer'];<br> }<br> $result = mysql_query($query);</p> </li> </ul> <p>while ($row = @mysql_fetch_assoc($result)) {<br> $node = $dom-&gt;createElement("marker");<br> $newnode = $parnode-&gt;appendChild($node);<br> $newnode-&gt;setAttribute("name",$row['name_poi']);<br> $newnode-&gt;setAttribute("lat", $row['Y']);<br> $newnode-&gt;setAttribute("lng", $row['X']);<br> $newnode-&gt;setAttribute("type", "restaurant");<br> }</p> <p>echo $dom-&gt;saveXML();</p> <p>mysql_free_result($result);<br> mysql_close($link);</p> <p>?&gt; </p> <p>Ce qui donne :) Attention le rayon maximum de recherche est de 50 km.</p> <h4 id=conclusion>Conclusion<a class=headerlink href=#conclusion title="Permanent link">#</a></h4> <p>Ces deux billets nous ont montré comment mettre en place un système de buffer avec une base de données MySQL. En fait ce n'est pas si compliqué que ça, il convient juste de bien cerner le problème : limiter la recherche à une bounding box calculée avec la formule Haversine. Après, les appels à la base de données et l'affichage sont maintenant des choses bien connues.<br> Si vous avez des remarques et / ou des suggestions, vous pouvez sans problème les soumettre dans les commentaires ou dans le ForumSIG.</p> <hr> <h2 id=auteur>Auteur<a class=headerlink href=#auteur title="Permanent link">#</a></h2> <p><img alt="Portait de GeoTribu" class=img-rdp-news-thumb src=https://cdn.geotribu.fr/img/internal/charte/geotribu_logo_64x64.png> <strong>GeoTribu</strong></p> <p>Toute l'actualité de la géomatique Open Source ! Mais aussi des tutoriels, des billets de blog, des tests et surtout une bonne humeur géographique !</p></div> </div> </div> <hr> <footer class=container> <center><span class=copyleft>&copy;</span> Geotribu</center> <center>Documentation built with <a href=http://www.mkdocs.org>MkDocs</a> and <a href=http://kristopolous.github.io/BOOTSTRA.386>BOOTSTRA.386</a>.</center> </footer> <script src=../../../../../../theme/assets/javascripts/extra.js></script> <script src=https://cdn.jsdelivr.net/npm/wa-mediabox@1.0.1/dist/wa-mediabox.min.js></script> <script src=https://unpkg.com/mermaid@8.6.4/dist/mermaid.min.js></script> <script src=../../../../../../search/main.js></script> </body> </html>